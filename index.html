<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cookie Test (Iframe)</title>
</head>
<body>
  <h2>Iframe Storage Access + Partitioned Cookie Test</h2>
  <button id="setCookie">Set Normal + Partitioned Cookies</button>
  <button id="checkAccess">Check Storage Access</button>
  <button id="requestAccess">Request Storage Access</button>
  <button id="showCookies">Show Cookies</button>
  <p id="status"></p>

  <script>
    const status = document.getElementById("status");

    function log(msg) {
      console.log(msg);
      status.innerText = msg;
    }

    // Set cookies: one normal third-party, one partitioned
    document.getElementById("setCookie").addEventListener("click", () => {
      try {
        // Normal third-party cookie (requires requestStorageAccess in Safari)
        document.cookie = "normalCookie=test123; SameSite=None; Secure";

        // Partitioned cookie (CHIPS)
        document.cookie = "partitionedCookie=chips456; Secure; SameSite=None; Partitioned";

        localStorage.setItem("testLocalStorage", Date.now());

        log("🍪 Normal + Partitioned cookies set, localStorage updated.");
      } catch (err) {
        log("Error setting cookies: " + err);
      }
    });

    // Check if API is supported
    if (document.hasStorageAccess) {
      log("requestStorageAccess API is supported.");
    } else {
      log("requestStorageAccess API is NOT supported in this browser.");
    }

    // Check current access
    document.getElementById("checkAccess").addEventListener("click", async () => {
      if (!document.hasStorageAccess) {
        log("API not available.");
        return;
      }
      try {
        const hasAccess = await document.hasStorageAccess();
        log(hasAccess ? "✅ Storage access already granted." : "❌ No storage access yet.");
      } catch (err) {
        log("Error checking access: " + err);
      }
    });

    // Request access
    document.getElementById("requestAccess").addEventListener("click", async () => {
      if (!document.requestStorageAccess) {
        log("API not available.");
        return;
      }
      try {
        await document.requestStorageAccess();
        log("🎉 Storage access granted!");
      } catch (err) {
        log("❌ Access request denied: " + err);
      }
    });

    // Show cookies visible in this iframe
    document.getElementById("showCookies").addEventListener("click", () => {
      log("Cookies visible here: " + document.cookie);
    });
  </script>
</body>
</html>
